<!-- 增强的Google Analytics 4跟踪 -->
{{ if site.Params.google_analytics_id }}
<script async src="https://www.googletagmanager.com/gtag/js?id={{ site.Params.google_analytics_id }}"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    
    gtag('config', '{{ site.Params.google_analytics_id }}', {
        // 增强电子商务跟踪
        enhanced_ecommerce: true,
        // 自动跟踪外链点击
        link_attribution: true,
        // 跟踪文件下载
        file_downloads: true,
        // 跟踪滚动深度
        page_title: document.title,
        page_location: window.location.href
    });

    // 跟踪AI工具评测页面的特定事件
    {{ if eq .Type "guides" }}
    gtag('event', 'page_view', {
        'page_category': 'AI Tool Guide',
        'ai_tool_name': '{{ .Params.title }}',
        'tool_category': '{{ index .Params.categories 0 }}',
        'rating': '{{ .Params.rating }}',
        'commercial_intent': '{{ .Params.commercial_intent }}'
    });
    {{ end }}

    // 跟踪外部链接点击（联盟营销）
    document.addEventListener('click', function(event) {
        if (event.target.tagName === 'A' && event.target.hostname !== window.location.hostname) {
            gtag('event', 'click', {
                'event_category': 'External Link',
                'event_label': event.target.href,
                'transport_type': 'beacon'
            });
        }
    });

    // 跟踪搜索功能使用
    document.addEventListener('DOMContentLoaded', function() {
        const searchForm = document.querySelector('.search-form');
        if (searchForm) {
            searchForm.addEventListener('submit', function(event) {
                const searchTerm = event.target.querySelector('input[type="search"]').value;
                gtag('event', 'search', {
                    'search_term': searchTerm
                });
            });
        }
    });

    // 跟踪滚动深度
    let scrollDepth = 0;
    let scrollTimer = null;
    
    window.addEventListener('scroll', function() {
        clearTimeout(scrollTimer);
        scrollTimer = setTimeout(function() {
            const currentDepth = Math.round((window.scrollY + window.innerHeight) / document.body.scrollHeight * 100);
            if (currentDepth > scrollDepth && currentDepth >= 25) {
                scrollDepth = Math.floor(currentDepth / 25) * 25;
                gtag('event', 'scroll', {
                    'event_category': 'User Engagement',
                    'event_label': scrollDepth + '%',
                    'value': scrollDepth
                });
            }
        }, 500);
    });
</script>
{{ end }}