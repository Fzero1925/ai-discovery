name: AI Discovery - Weekly Content Planning

on:
  schedule:
    # Run every Monday at 8:00 AM Beijing Time (00:00 UTC Monday)
    - cron: '0 0 * * 1'
  workflow_dispatch: # Allow manual trigger

env:
  HUGO_VERSION: "0.149.0"

jobs:
  weekly-planning:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Weekly content strategy
        run: |
          echo "📅 Weekly AI Discovery Content Planning - $(date)"
          echo "================================================="
          
          # Define weekly content themes
          WEEK=$(date +%U)
          THEME_INDEX=$((WEEK % 4))
          
          case $THEME_INDEX in
            0) THEME="Image Generation Week"; TOOLS="Midjourney,DALL-E 3,Stable Diffusion,Adobe Firefly" ;;
            1) THEME="Code Assistant Week"; TOOLS="GitHub Copilot,Amazon CodeWhisperer,Tabnine,Codeium" ;;
            2) THEME="Content Creation Week"; TOOLS="ChatGPT,Claude,Jasper AI,Copy.ai" ;;
            3) THEME="Productivity Week"; TOOLS="Notion AI,Grammarly,Zapier,DataRobot" ;;
          esac
          
          echo "🎯 This Week's Theme: $THEME"
          echo "🛠️ Focus Tools: $TOOLS"
          
          # Generate content plan
          echo "📋 Weekly Content Plan:"
          echo "- Monday: Main tool comprehensive review"
          echo "- Wednesday: Alternative tools comparison"  
          echo "- Friday: Use case deep-dive and tutorials"
          echo "- Sunday: Weekly roundup and tool updates"
          
          # Save plan for other workflows
          echo "WEEKLY_THEME=$THEME" >> weekly_plan.txt
          echo "FOCUS_TOOLS=$TOOLS" >> weekly_plan.txt

      - name: Trigger targeted content generation
        run: |
          echo "🚀 Triggering weekly content generation..."
          
          # Read the weekly plan
          FOCUS_TOOLS=$(grep "FOCUS_TOOLS=" weekly_plan.txt | cut -d'=' -f2)
          
          # Trigger manual content update with this week's focus tools
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/manual-content-update.yml/dispatches \
            -d "{\"ref\":\"main\",\"inputs\":{\"tool_names\":\"$FOCUS_TOOLS\",\"force_regenerate\":\"true\",\"deploy_immediately\":\"true\"}}"
          
          echo "✅ Weekly content generation triggered"

      - name: Send weekly planning notification
        if: always()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ "${{ secrets.TELEGRAM_BOT_TOKEN }}" != "" ] && [ "${{ secrets.TELEGRAM_CHAT_ID }}" != "" ]; then
            python scripts/telegram_notify.py \
              --type custom \
              --message "📅 **AI Discovery Weekly Planning** $(date +'%Y-%m-%d')
              
🎯 **本周主题**: $(grep 'WEEKLY_THEME=' weekly_plan.txt | cut -d'=' -f2)
🛠️ **重点工具**: $(grep 'FOCUS_TOOLS=' weekly_plan.txt | cut -d'=' -f2)

📋 **内容计划**:
• 周一: 主要工具深度评测
• 周三: 替代工具对比分析  
• 周五: 使用场景和教程
• 周日: 每周总结和工具更新

🤖 **自动化状态**: 
✅ 每日内容生成已启动
✅ 自动部署和通知正常
✅ SEO优化和质量监控运行中

_Claude Code 智能运营系统_"
          else
            echo "⚠️ Telegram credentials not configured"
          fi

      - name: Commit weekly plan
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "AI Discovery Planning Bot"
          
          # Add weekly plan file
          git add weekly_plan.txt || true
          
          if ! git diff --staged --quiet; then
            git commit -m "📅 Weekly content planning - $(date +'%Y-%m-%d')

🎯 Theme: $(grep 'WEEKLY_THEME=' weekly_plan.txt | cut -d'=' -f2)
🛠️ Focus: $(grep 'FOCUS_TOOLS=' weekly_plan.txt | cut -d'=' -f2)

Automated weekly content strategy activation

🔍 Generated with [Claude Code](https://claude.ai/code)

Co-Authored-By: Claude <noreply@anthropic.com>"
            
            git push
            echo "✅ Weekly plan committed"
          else
            echo "No changes to commit"
          fi

      - name: Cleanup
        if: always()
        run: |
          rm -f weekly_plan.txt
          echo "🧹 Cleanup completed"