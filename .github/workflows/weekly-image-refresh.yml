name: Weekly Image Refresh - AI Discovery

on:
  schedule:
    # æ¯å‘¨æ—¥å‡Œæ™¨2ç‚¹è¿è¡Œ (åŒ—äº¬æ—¶é—´10ç‚¹)
    - cron: '0 2 * * 0'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      refresh_count:
        description: 'Number of tools to refresh images for'
        required: false
        default: '10'
        type: string
      force_refresh:
        description: 'Force refresh existing images'
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: '3.11'

jobs:
  refresh-images:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests Pillow python-dateutil

      - name: Setup environment variables
        run: |
          echo "UNSPLASH_ACCESS_KEY=${{ secrets.UNSPLASH_ACCESS_KEY }}" >> .env

      - name: Create images directory
        run: |
          mkdir -p static/images/tools
          mkdir -p static/images/cache

      - name: Check Unsplash API availability
        id: check_api
        run: |
          if [ -z "${{ secrets.UNSPLASH_ACCESS_KEY }}" ]; then
            echo "api_available=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Unsplash API key not configured, skipping image refresh"
          else
            echo "api_available=true" >> $GITHUB_OUTPUT
            echo "âœ… Unsplash API key found"
          fi

      - name: Refresh AI tool images
        if: steps.check_api.outputs.api_available == 'true'
        id: refresh
        run: |
          echo "ğŸ–¼ï¸ Starting weekly image refresh..."
          
          # è¿è¡Œå›¾ç‰‡æ›´æ–°è„šæœ¬
          python scripts/real_image_fetcher.py --limit ${{ github.event.inputs.refresh_count || '10' }}
          
          # ç»Ÿè®¡æ–°è·å–çš„å›¾ç‰‡
          if [ -d "static/images/tools" ]; then
            NEW_IMAGES=$(find static/images/tools -name "*.jpg" -mtime -1 | wc -l)
            echo "refreshed_count=$NEW_IMAGES" >> $GITHUB_OUTPUT
            echo "ğŸ“¸ Refreshed $NEW_IMAGES images"
          else
            echo "refreshed_count=0" >> $GITHUB_OUTPUT
          fi

      - name: Optimize new images
        if: steps.check_api.outputs.api_available == 'true' && steps.refresh.outputs.refreshed_count > 0
        run: |
          echo "âš¡ Optimizing new images..."
          
          # å‹ç¼©æ–°å›¾ç‰‡
          find static/images/tools -name "*.jpg" -mtime -1 -exec python -c "
          from PIL import Image
          import sys
          try:
              img = Image.open('$1')
              img = img.convert('RGB')
              img.save('$1', 'JPEG', quality=85, optimize=True)
              print('Optimized: $1')
          except Exception as e:
              print(f'Error optimizing $1: {e}')
          " {} \;

      - name: Commit new images
        if: steps.check_api.outputs.api_available == 'true' && steps.refresh.outputs.refreshed_count > 0
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "AI Discovery Image Bot"
          
          # æ·»åŠ æ–°å›¾ç‰‡
          git add static/images/tools/*.jpg
          git add static/images/cache/*.jpg
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
          if ! git diff --staged --quiet; then
            COMMIT_MSG="ğŸ–¼ï¸ Weekly image refresh - $(date +'%Y-%m-%d')

ğŸ“¸ Refreshed: ${{ steps.refresh.outputs.refreshed_count }} AI tool images
ğŸ¨ Updated with high-quality Unsplash photos
âš¡ Automatically optimized for web performance

ğŸ”§ Generated with Claude Code AI Assistant
Co-Authored-By: Claude <noreply@anthropic.com>"
            
            git commit -m "$COMMIT_MSG"
            git push
            
            echo "âœ… Successfully committed ${{ steps.refresh.outputs.refreshed_count }} new images"
          else
            echo "â„¹ï¸ No new images to commit"
          fi

      - name: Send Telegram notification
        if: always()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ "${{ secrets.TELEGRAM_BOT_TOKEN }}" != "" ] && [ "${{ secrets.TELEGRAM_CHAT_ID }}" != "" ]; then
            echo "ğŸ“± Sending image refresh notification..."
            
            # åˆ›å»ºé€šçŸ¥è„šæœ¬
            cat > notify_image_refresh.py << 'EOF'
import os
import requests
from datetime import datetime
import pytz

def send_notification():
    bot_token = os.getenv('TELEGRAM_BOT_TOKEN')
    chat_id = os.getenv('TELEGRAM_CHAT_ID')
    
    china_tz = pytz.timezone('Asia/Shanghai')
    china_time = datetime.now(china_tz).strftime('%m-%d %H:%M')
    
    api_available = '${{ steps.check_api.outputs.api_available }}'
    refreshed_count = '${{ steps.refresh.outputs.refreshed_count || 0 }}'
    
    if api_available == 'true':
        if int(refreshed_count) > 0:
            status_emoji = "ğŸ–¼ï¸"
            status_text = f"å›¾ç‰‡åˆ·æ–°å®Œæˆ"
            details = f"""ğŸ“¸ *æœ¬å‘¨å›¾ç‰‡æ›´æ–°*:
â€¢ æ–°è·å–å›¾ç‰‡: {refreshed_count}å¼ 
â€¢ å›¾ç‰‡æ¥æº: Unsplashé«˜è´¨é‡ç…§ç‰‡
â€¢ è‡ªåŠ¨ä¼˜åŒ–: âœ… Webæ€§èƒ½ä¼˜åŒ–
â€¢ ç¼“å­˜æ›´æ–°: âœ… å·²æ›´æ–°

ğŸ¨ *å›¾ç‰‡è´¨é‡æå‡*:
â€¢ åˆ†è¾¨ç‡: 1200x630 (OGæ ‡å‡†)
â€¢ å‹ç¼©æ¯”: 85% (æœ€ä½³å¹³è¡¡)
â€¢ åŠ è½½é€Ÿåº¦: âš¡ å¿«é€ŸåŠ è½½
â€¢ SEOå‹å¥½: âœ… Altæ ‡ç­¾å®Œæ•´

ğŸ“Š *ç³»ç»ŸçŠ¶æ€*:
â€¢ Unsplash API: ğŸŸ¢ æ­£å¸¸
â€¢ è‡ªåŠ¨åŒ–ç¨‹åº¦: 100%
â€¢ ä¸‹æ¬¡åˆ·æ–°: ä¸‹å‘¨æ—¥ 10:00"""
        else:
            status_emoji = "â„¹ï¸"
            status_text = "å›¾ç‰‡åˆ·æ–°è·³è¿‡"
            details = "ğŸ“‹ æœ¬å‘¨æ— éœ€åˆ·æ–°å›¾ç‰‡\nğŸ” æ‰€æœ‰å›¾ç‰‡å‡ä¸ºæœ€æ–°çŠ¶æ€"
    else:
        status_emoji = "âš ï¸"
        status_text = "APIæœªé…ç½®"
        details = """ğŸ”§ *éœ€è¦é…ç½®*:
â€¢ Unsplash Access Key æœªè®¾ç½®
â€¢ è¯·åœ¨GitHub Secretsä¸­æ·»åŠ  UNSPLASH_ACCESS_KEY
â€¢ é…ç½®åå³å¯è‡ªåŠ¨è·å–é«˜è´¨é‡å›¾ç‰‡"""
    
    message = f"""{status_emoji} *AI Discovery å›¾ç‰‡ç³»ç»Ÿ* | {china_time}

ğŸ¯ *{status_text}*

{details}

*ç½‘ç«™*: [ai-discovery-nu.vercel.app](https://ai-discovery-nu.vercel.app/)

_ğŸ¤– Claude Code è‡ªåŠ¨å›¾ç‰‡ç®¡ç†ç³»ç»Ÿ_"""
    
    url = f"https://api.telegram.org/bot{bot_token}/sendMessage"
    payload = {
        'chat_id': chat_id,
        'text': message,
        'parse_mode': 'Markdown',
        'disable_web_page_preview': True
    }
    
    try:
        response = requests.post(url, data=payload, timeout=10)
        if response.status_code == 200:
            print("âœ… Telegram notification sent")
        else:
            print(f"âŒ Telegram error: {response.status_code}")
    except Exception as e:
        print(f"âŒ Notification failed: {e}")

if __name__ == "__main__":
    send_notification()
EOF
            
            python notify_image_refresh.py
          else
            echo "â„¹ï¸ Telegram credentials not configured, skipping notification"
          fi

      - name: Performance summary
        if: always()
        run: |
          echo "## ğŸ–¼ï¸ AI Discovery å›¾ç‰‡åˆ·æ–°æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_api.outputs.api_available }}" = "true" ]; then
            echo "### âœ… åˆ·æ–°å®Œæˆ" >> $GITHUB_STEP_SUMMARY
            echo "- APIçŠ¶æ€: Unsplash å¯ç”¨" >> $GITHUB_STEP_SUMMARY
            echo "- åˆ·æ–°å›¾ç‰‡: ${{ steps.refresh.outputs.refreshed_count || 0 }}å¼ " >> $GITHUB_STEP_SUMMARY
            echo "- ä¼˜åŒ–å¤„ç†: âœ… å·²å®Œæˆ" >> $GITHUB_STEP_SUMMARY
            echo "- è‡ªåŠ¨æäº¤: âœ… å·²æ¨é€" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ éœ€è¦é…ç½®" >> $GITHUB_STEP_SUMMARY
            echo "- APIçŠ¶æ€: Unsplash æœªé…ç½®" >> $GITHUB_STEP_SUMMARY
            echo "- è§£å†³æ–¹æ¡ˆ: æ·»åŠ  UNSPLASH_ACCESS_KEY åˆ° GitHub Secrets" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š ç³»ç»ŸæŒ‡æ ‡" >> $GITHUB_STEP_SUMMARY
          echo "- è‡ªåŠ¨åŒ–ç¨‹åº¦: 100%" >> $GITHUB_STEP_SUMMARY
          echo "- å›¾ç‰‡è´¨é‡: é«˜è´¨é‡ Unsplash" >> $GITHUB_STEP_SUMMARY
          echo "- åˆ·æ–°å‘¨æœŸ: æ¯å‘¨æ—¥æ‰§è¡Œ" >> $GITHUB_STEP_SUMMARY
          echo "- ä¸‹æ¬¡æ‰§è¡Œ: $(date -d 'next sunday' '+%Y-%m-%d 10:00 ä¸­å›½æ—¶é—´')" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup
        if: always()
        run: |
          rm -f notify_image_refresh.py
          echo "ğŸ§¹ Cleanup completed"